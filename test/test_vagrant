#! /usr/bin/ruby
#
# Integration testing of BioLinux targets - see 
#
#   ./test/test_vagrant --help
#

# Available testing targets - this could be read from a YAML file.
BOX = { 'Minimal' => 
           { :url => 'http://mathie-vagrant-boxes.s3.amazonaws.com/debian_squeeze_32.box' }
}

print "Integration test script for CloudBioLinux\n"

def run cmd
  print "--> ",cmd
  system(cmd)
end

if ARGV.index('-h') or ARGV.index('--help')
  print <<USAGE

  Usage:

    test_vagrant [--running] [edition] [flavor]

      --running     Use an already running VM (no VM setup)
      edition       The target edition (default Minimal)
      flavor        The target flavor (default Minimal)

  Example:

     cd cloudbiolinux/test
     test_vagrant Minimal       # test Minimal edition

  The base install name.box will be pulled over the Internet, unless
  it exist in the local directory.

  Note: this testing framework is under development

  Available targets:

USAGE
  BOX.each do | edition, properties |
    print "* ", edition, " (",properties[:url],")\n"
  end
  exit 0
end

srcpath = File.dirname(File.dirname(__FILE__))

edition_name = ARGV.shift
use_running_vm = false
if edition_name == '--running'
  use_running_vm = true
  edition_name = ARGV.shift
end
edition_name = 'Minimal' if !edition_name
flavor_name  = ARGV.shift
flavor_name  = 'Minimal' if !flavor_name

print "Testing edition '#{edition_name}' flavor '#{flavor_name}'\n"
raise "Unknown box for #{edition_name}" if !BOX[edition_name]
remotebox = BOX[edition_name][:url]
localbox = File.basename(remotebox)

# find or install vagrant
print "gem install vagrant" if `which vagrant` !~ /vagrant/

# Name a temporary dir
testname = "biolinux_"+File.basename(localbox,".box")

if use_running_vm
  print "Using already running VM #{testname}\n"
else
  # Remove old box, if there
  run "vagrant box remove #{testname}"

  if File.exist?(localbox)
    print "Starting from local #{localbox}\n"
    run "vagrant box add #{testname} #{localbox}"
  else
    print "Fetching #{remotebox}\n"
    run "vagrant box add #{testname} #{remotebox}"
  end

  Dir.mkdir(testname) if !File.directory?(testname)
  # Bring VM up
  Dir.chdir(testname) do
    print `ls -l`
    run "vagrant init #{testname}"
    run "vagrant up"
  end
end

if not File.directory?(testname)
  $stderr.print "VM #{testname} appears not to be installed"
  exit 1
end

# Using the VM
Dir.chdir(testname) do
  # Fetch the vagrant ssh key, and store it locally
  # First see if we can copy a file - if we can there is no need to update .ssh/config
  File.unlink('remote_hosts') if File.exists?('remote_hosts')
  run "scp vagrant:/etc/hosts remote_hosts"
  if !File.exist?('remote_hosts')
    run "vagrant ssh-config >> ~/.ssh/config"
    run "scp vagrant:/etc/hosts remote_hosts"
  end
  raise "Problem connecting to remote hosts (using scp)" if !File.exist?('remote_hosts')
  File.unlink('remote_hosts')
  # run "vagrant status"
  print "We can use #{testname}!\n"
end

# export source=/path/to/cloudbiolinux
# fab -f $source/fabfile.py -H vagrant  -c $source/contrib/minimal/fabricrc_debian.txt install_biolinux:packagelist=$source/contrib/minimal/main.yaml

